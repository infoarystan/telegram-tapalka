const tg=window.Telegram.WebApp;if(tg){tg.expand();tg.ready();}let score=0,totalTaps=0,timeLeft=30,gameActive=false,multiplier=1,level=1,tapsToNextLevel=100,streakDays=0,lastLogin=null,referralCount=0,hasTurbo=false,timerId=null;const user=tg?.initDataUnsafe?.user;document.getElementById('userName').textContent=user?.first_name||'Player';if(user?.photo_url)document.getElementById('userAvatar').src=user.photo_url;function updateDisplay(){document.getElementById('currentScore').textContent=score;document.getElementById('totalTaps').textContent=totalTaps;document.getElementById('userLevel').textContent=level;document.getElementById('multiplier').textContent=multiplier+'x';document.getElementById('streakDays').textContent=streakDays;const progress=Math.min((totalTaps/(tapsToNextLevel))*100,100);document.getElementById('progressFill').style.width=progress+'%';document.getElementById('levelText').textContent=`Level ${level}: ${totalTaps}/${tapsToNextLevel} taps`;}function loadGameState(){const saved=localStorage.getItem('tapMasterState');if(saved){const state=JSON.parse(saved);totalTaps=state.totalTaps||0;level=state.level||1;streakDays=state.streakDays||0;lastLogin=state.lastLogin;referralCount=state.referralCount||0;hasTurbo=state.hasTurbo||false;updateLevel();checkStreak();}updateDisplay();}function saveGameState(){const state={totalTaps,level,streakDays,lastLogin:new Date().toISOString().split('T')[0],referralCount,hasTurbo};localStorage.setItem('tapMasterState',JSON.stringify(state));}function updateLevel(){const levels=[0,100,300,600,1000,1500];for(let i=levels.length-1;i>=0;i--){if(totalTaps>=levels[i]){level=i+1;tapsToNextLevel=levels[i+1]||levels[i]*2;break;}}}function checkStreak(){const today=new Date().toISOString().split('T')[0];if(lastLogin===today)return;if(lastLogin){const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);const yesterdayStr=yesterday.toISOString().split('T')[0];if(lastLogin===yesterdayStr)streakDays++;else streakDays=1;}else streakDays=1;lastLogin=today;saveGameState();}function startGame(){if(gameActive)return;score=0;timeLeft=30;gameActive=true;const startBtn=document.getElementById('startBtn');startBtn.disabled=true;if(timerId)clearInterval(timerId);timerId=setInterval(()=>{timeLeft--;document.getElementById('timeLeft').textContent=timeLeft;if(timeLeft<=0){clearInterval(timerId);timerId=null;gameActive=false;startBtn.disabled=false;totalTaps+=score;updateLevel();saveGameState();updateDisplay();}},1000);updateDisplay();}function tap(){if(!gameActive)return;let tapValue=1;if(hasTurbo)tapValue+=2;score+=tapValue*multiplier;updateDisplay();}document.getElementById('tapBtn').addEventListener('click',tap);document.getElementById('tapCircle').addEventListener('click',tap);document.getElementById('startBtn').addEventListener('click',startGame);document.getElementById('adMultiplier').addEventListener('click',()=>{if(tg&&typeof tg.showAd==='function'){tg.showAd('multiplier_ad',()=>{multiplier=2;updateDisplay();setTimeout(()=>{multiplier=1;updateDisplay();},60000);});}else{multiplier=2;updateDisplay();setTimeout(()=>{multiplier=1;updateDisplay();},60000);}});document.getElementById('adTaps').addEventListener('click',()=>{if(tg&&typeof tg.showAd==='function'){tg.showAd('bonus_taps_ad',()=>{score+=25;updateDisplay();});}else{score+=25;updateDisplay();}});document.getElementById('turboPack').addEventListener('click',()=>{if(tg&&typeof tg.openInvoice==='function'){tg.openInvoice('turbo_pack_invoice',(status)=>{if(status==='paid'){hasTurbo=true;saveGameState();}});}else{hasTurbo=true;saveGameState();alert('Turbo Tapper purchased!');}});document.getElementById('skinPack').addEventListener('click',()=>{if(tg&&typeof tg.openInvoice==='function')tg.openInvoice('skin_pack_invoice');else alert('Premium feature simulated');});document.getElementById('inviteFriend').addEventListener('click',()=>{const shareUrl=`https://t.me/share/url?url=${encodeURIComponent('https://t.me/your_bot/app')}&text=Beat my score of ${score} in TapMaster!`;window.open(shareUrl,'_blank');});document.getElementById('shareLink').addEventListener('click',()=>{const refLink=`https://t.me/your_bot/app?startapp=ref_${user?.id||'0'}`;if(tg&&tg.shareUrl)tg.shareUrl(refLink,'Join TapMaster via my referral for bonus points!');else alert('Share link: '+refLink);});document.getElementById('claimReward').addEventListener('click',()=>{const rewards=[10,15,20,25,30,35,40];const reward=rewards[Math.min(streakDays-1,rewards.length-1)]||50;score+=reward;updateDisplay();document.getElementById('dailyReward').textContent=`Claimed +${reward} taps!`;document.getElementById('claimReward').disabled=true;});function loadLeaderboard(){const mockData=[{name:'Alice',refs:12},{name:'Bob',refs:8},{name:'You',refs:referralCount}];const leaderboardHTML=mockData.map(p=>`<div class="leaderboard-entry"><span>${p.name}</span><span>${p.refs} referrals</span></div>`).join('');document.getElementById('leaderboard').innerHTML=leaderboardHTML;}loadGameState();loadLeaderboard();setInterval(saveGameState,30000);